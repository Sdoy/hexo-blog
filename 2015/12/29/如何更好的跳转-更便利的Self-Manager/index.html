<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>如何更好的跳转,更便利的Self-Manager | Sdoy</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">如何更好的跳转,更便利的Self-Manager</h1><a id="logo" href="/.">Sdoy</a><p class="description">Push the limits</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> Inicio</i></a><a href="/archives/"><i class="icon-archive"> Archivo</i></a><a href="/about/"><i class="icon-about"> Acerca de</i></a><a href="/atom.xml"><i class="icon-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">如何更好的跳转,更便利的Self-Manager</h1><div class="post-meta">2015-12-29 | </div><div class="post-content"><h2 id="我们在开发过程中总会遇到如下场景："><a href="#我们在开发过程中总会遇到如下场景：" class="headerlink" title="我们在开发过程中总会遇到如下场景："></a>我们在开发过程中总会遇到如下场景：</h2><p>1.tableviewcell(view)中的控件点击需要跳转到各种页面</p>
<p>2.在使用app或者开打app，需要处理远程通知的跳转</p>
<h2 id="跳转总是需要CurrentViewController"><a href="#跳转总是需要CurrentViewController" class="headerlink" title="跳转总是需要CurrentViewController"></a>跳转总是需要CurrentViewController</h2><p>在app中做跳转，我们总是需要获得一个可以ViewController来做转场动画，通常的场景就是正在展示的ViewController做push或者present，特别是在<a href="http://blog.sunnyxx.com/2015/12/19/self-manager-pattern-in-ios/" target="_blank" rel="external">Self-Manager这种思想下</a>,因为控件的self-manager之后需要handle事件，比如跳转</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FDAvatarView</span> (<span class="title">FDAvatarViewSelfManager</span>)</span></span><br><span class="line"><span class="comment">// 为后一个页面的创建增加了个 UID 参数</span></span><br><span class="line">- (<span class="keyword">void</span>)selfManagedConfigureWithAvatarURL:(<span class="built_in">NSURL</span> *)URL VIPInfo:(<span class="keyword">id</span>)info <span class="built_in">UID</span>:(<span class="built_in">NSString</span> *)<span class="built_in">UID</span> &#123;</span><br><span class="line">    [<span class="keyword">self</span> configureWithAvatarURL:URL VIPInfo:info tapped:^&#123;</span><br><span class="line">        <span class="comment">// 假设 App 结构是 Root -&gt; TabBar -&gt; Navigation -&gt; ViewController</span></span><br><span class="line">        <span class="built_in">UITabBarController</span> *tabBarControler = (<span class="keyword">id</span>)[<span class="built_in">UIApplication</span>.sharedApplication.delegate.window.rootViewController;</span><br><span class="line">        <span class="built_in">UINavigationController</span> *navigationController = tabBarControler.selectedViewController;</span><br><span class="line">        <span class="comment">// 创建用户信息 View Controller</span></span><br><span class="line">        FDUserProfileViewController *profileViewController = [FDUserProfileViewController viewControllerWith<span class="built_in">UID</span>:<span class="built_in">UID</span>];</span><br><span class="line">        [navigationController pushViewController:profileViewController animated:<span class="literal">YES</span>];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>然而控件可能会出现在各种各样的ViewController中，如何获得当前的ViewController</p>
<h2 id="获得CurrentViewController"><a href="#获得CurrentViewController" class="headerlink" title="获得CurrentViewController"></a>获得CurrentViewController</h2><p>demo地址：<a href="https://github.com/Sdoy/CurrentViewController" target="_blank" rel="external">https://github.com/Sdoy/CurrentViewController</a></p>
<p>写一个继承自UIViewController的子类，就叫BaseViewController<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">BaseViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>然后在BaseViewController中将self绑定到Application中的currentViewController属性<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">BaseViewController</span></span></span><br><span class="line">-(<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewWillAppear:animated];</span><br><span class="line">    [<span class="built_in">UIApplication</span> sharedApplication].currentViewController=<span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>恩，如何绑定？<br>为UIApplication写一个Category<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIApplication</span> (<span class="title">CurrentViewController</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="built_in">UIViewController</span> *currentViewController;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><br>.m文件<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"UIApplication+CurrentViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIApplication</span> (<span class="title">CurrentViewController</span>)</span></span><br><span class="line">-(<span class="keyword">void</span>)setCurrentViewController:(<span class="built_in">UIViewController</span> *)currentViewController</span><br><span class="line">&#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(currentViewController), currentViewController, OBJC_ASSO<span class="built_in">CIATION_ASSIGN</span>);</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="built_in">UIViewController</span> *)currentViewController</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>至此，只要你的ViewController都是继承自BaseViewController，你就可以在任何地方都能拿到CurrentViewController了，调用起来是这样的</p>
<p>比如收到了远程通知：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application didReceiveRemoteNotification:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    <span class="comment">//You can esay find out which view controller is on the screen here.</span></span><br><span class="line">    <span class="built_in">UIViewController</span> *currentVC=[<span class="built_in">UIApplication</span> sharedApplication].currentViewController;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,currentVC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者在子控件做跳转：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//if you want to go another view controller when you touch this view</span></span><br><span class="line"><span class="comment">//you don't need create a delegate to let the display or some view controller to perform SEL</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[<span class="built_in">UIApplication</span> sharedApplication].currentViewController);</span><br><span class="line">    AnotherViewController *another=[[AnotherViewController alloc]init];</span><br><span class="line">    [[<span class="built_in">UIApplication</span> sharedApplication].currentViewController.navigationController pushViewController:another animated:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而且还写了3个宏定义,用起来更方便<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define CurrentVC [UIApplication sharedApplication].currentViewController</span></span><br><span class="line"><span class="meta">#define PushVC(ViewController) [[UIApplication sharedApplication].currentViewController.navigationController pushViewController:ViewController animated:YES]</span></span><br><span class="line"><span class="meta">#define PresentVC(ViewController)\</span></span><br><span class="line"><span class="built_in">UINavigationController</span> *nv=[[<span class="built_in">UINavigationController</span> alloc]initWithRootViewController:ViewController];\</span><br><span class="line">[[<span class="built_in">UIApplication</span> sharedApplication].currentViewController presentViewController:nv animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>]</span><br></pre></td></tr></table></figure></p>
<h2 id="为什么不直接hook，UIViewController的viewWillAppear-方法？"><a href="#为什么不直接hook，UIViewController的viewWillAppear-方法？" class="headerlink" title="为什么不直接hook，UIViewController的viewWillAppear:方法？"></a>为什么不直接hook，UIViewController的viewWillAppear:方法？</h2><p>因为很多苹果的私有组件都是继承自UIViewController的，他们也许是没有nav的.</p>
<h2 id="编后："><a href="#编后：" class="headerlink" title="编后："></a>编后：</h2><p>首先感谢<a href="http://blog.sunnyxx.com/" target="_blank" rel="external">sunnyxx</a>抽时间看了文章以及分享的如何获取current的代码<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">FDTopViewController</span>)</span></span><br><span class="line">+ (<span class="built_in">UIViewController</span>*)topViewControllerWithRootViewController:(<span class="built_in">UIViewController</span>*)rootViewController &#123;</span><br><span class="line">    <span class="keyword">if</span> ([rootViewController isKindOfClass:[<span class="built_in">UITabBarController</span> class]]) &#123;</span><br><span class="line">        <span class="built_in">UITabBarController</span>* tabBarController = (<span class="built_in">UITabBarController</span>*)rootViewController;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> topViewControllerWithRootViewController:tabBarController.selectedViewController];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([rootViewController isKindOfClass:[<span class="built_in">UINavigationController</span> class]]) &#123;</span><br><span class="line">        <span class="built_in">UINavigationController</span>* navigationController = (<span class="built_in">UINavigationController</span>*)rootViewController;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> topViewControllerWithRootViewController:navigationController.visibleViewController];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rootViewController.presentedViewController) &#123;</span><br><span class="line">        <span class="built_in">UIViewController</span>* presentedViewController = rootViewController.presentedViewController;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> topViewControllerWithRootViewController:presentedViewController];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rootViewController;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><br>的确，这样的方法更利于老项目的修改，而且从使用方便的角度讲比文中提到的好太多了，虽然可能多调几次方法，和多走几次if判断，但基本不会成为app性能的瓶颈。</p>
</div><div class="tags"><a href="/tags/iOS/">iOS</a></div><div class="post-nav"><a href="/2016/01/06/Mac练手小项目/" class="pre"><i class="icon-previous">Mac练手小项目</i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://sdoy.github.io"/></form></div><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="si" value="http://sdoy.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title">Categorías</div></div><div class="widget"><div class="widget-title">Etiquetas</div><div class="tagcloud"><a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/CoreText/" style="font-size: 15px;">CoreText</a> <a href="/tags/NSAttributedString/" style="font-size: 15px;">NSAttributedString</a> <a href="/tags/Xcode/" style="font-size: 15px;">Xcode</a></div></div><div class="widget"><div class="widget-title">Recientes</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/03/15/iOS中富文本的AttributeNames/">iOS中富文本的AttributeNames</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/14/一些奇淫技巧(遇到一个记一个)/">Tips</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/06/Mac练手小项目/">Mac练手小项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/29/如何更好的跳转-更便利的Self-Manager/">如何更好的跳转,更便利的Self-Manager</a></li></ul></div><div class="widget"><div class="widget-title">Blogroll</div></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">Sdoy.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js"></script>
<script src="/js/totop.js"></script><script src="/js/fancybox.pack.js"></script>
<script src="/js/jquery.fancybox.js"></script><link rel="stylesheet" href="/css/jquery.fancybox.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7821fcd4d41e6dc1de52c44aa6c77de7";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></div></body></html>